<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
            cursor: pointer;
            position: relative;
            padding-right: 25px;
        }
        th:hover {
            background-color: #e0e0e0;
        }
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        th.sort-asc::after {
            border-bottom: 5px solid #333;
            margin-top: -2.5px;
        }
        th.sort-desc::after {
            border-top: 5px solid #333;
            margin-top: 2.5px;
        }
        /* ปรับแต่งไอคอน sort */
        th::before,
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.3;
        }
        th::before {
            top: 40%;
            border-bottom: 5px solid #666;
        }
        th::after {
            top: 55%;
            border-top: 5px solid #666;
        }
        /* ไอคอนเมื่อ active */
        th.sort-asc::before {
            opacity: 1;
            border-bottom-color: #333;
        }
        th.sort-desc::after {
            opacity: 1;
            border-top-color: #333;
        }
        /* เมื่อ hover ทำให้ไอคอนเด่นขึ้น */
        th:hover::before,
        th:hover::after {
            opacity: 0.6;
        }
        .pivot-table th, .pivot-table td {
            background-color: #e6f3ff; /* สีพื้นหลังเหมือนในภาพ */
        }
        .pivot-table th:first-child, .pivot-table td:first-child {
            background-color: #d9ead3; /* สีเขียวอ่อนสำหรับคอลัมน์แรก */
        }
        .grand-total th, .grand-total td {
            background-color: #b7e1cd; /* สีเขียวเข้มสำหรับแถว Grand Total */
        }
        .area-total {
            color: #006400; /* สีเขียวเข้ม */
        }
        canvas {
            margin-top: 20px;
            max-width: 800px; /* เพิ่มขนาดกราฟ */
            max-height: 400px;
        }
        .controls {
            margin-bottom: 20px;
        }
        .controls button {
            margin-right: 10px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        .pivot-table {
            margin-bottom: 5px; /* ลดช่องว่างระหว่างตารางสรุปกับตารางหลัก */
        }
        .header-container {
            background-color: #003366; /* สีน้ำเงินเข้ม */
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        #chart-container {
            position: relative;
            display: flex; /* จัดวางกราฟให้อยู่ข้างกัน */
        }
        #chart-label {
            position: absolute;
            top: -20px; /* ปรับตำแหน่งตามความเหมาะสม */
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
        }
        .chart-wrapper {
            width: 50%; /* ปรับขนาดให้เหมาะสม */
            padding: 10px;
            box-sizing: border-box;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="header-container">
        <h1>ข้อมูลแดชบอร์ดสถานะการอบรมช่างใหม่(2025)</h1>
        <p id="current-date"></p>
    </div>
    <div class="controls">
        <button id="refresh-button">รีเฟรชข้อมูล</button>
        <button id="download-button">ดาวน์โหลด</button>
    </div>

    <div id="chart-container">
        <div class="chart-wrapper">
            <div id="chart-label">Status การขึ้นทะเบียนช่างใหม่ประจำเดือน</div>
            <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="lineChart" width="400" height="400"></canvas>
        </div>
    </div>

    <h2>สถานะการอบรมช่างใหม่รายพื้นที่</h2>
    <table id="pivot-table" class="pivot-table">
        <thead>
            <tr id="pivot-header"></tr>
        </thead>
        <tbody id="pivot-body"></tbody>
    </table>

    <table id="data-table">
        <thead>
            <tr></tr>
        </thead>
        <tbody id="data-body"></tbody>
    </table>

    <script>
        // ฟังก์ชันเพื่ออัปเดตวันที่และเวลาปัจจุบันในรูปแบบประเทศไทย
        function updateCurrentDateTime() {
            const currentDateElement = document.getElementById('current-date');
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            const thaiYear = now.getFullYear() + 543;
            const thaiDate = now.toLocaleDateString('th-TH', options).replace(now.getFullYear(), thaiYear);
            currentDateElement.textContent = `วันที่: ${thaiDate}`;
        }

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        setInterval(updateCurrentDateTime, 1000);

        // URL for Google Sheets
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLKGmFsdD4oMcVdnf_wyrwAD3-3R7Ys9hXCg2gwBsudfJIUliRymBnVYHapN7a3Yq08Lgxf9cYYV6Y/pub?gid=377151035&single=true&output=csv";

        let chart;
        let originalData;
        let filteredData2025;
        let lineChart;

        // ฟังก์ชันเพื่อดึงข้อมูลและอัปเดตตาราง
        function fetchDataAndUpdateTable() {
            fetch(sheetUrl)
                .then(response => response.text())
                .then(csvText => {
                    // แปลง CSV เป็น JSON
                    const rows = [];
                    const lines = csvText.split('\n');
                    
                    // ข้ามบรรทัดแรก (หัวตาราง)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {  // ตรวจสอบว่าไม่ใช่บรรทัดว่าง
                            let currentChar = 0;
                            let inQuotes = false;
                            let currentValue = '';
                            const values = [];
                            
                            // วนลูปทีละตัวอักษรเพื่อแยกค่าที่ถูกต้อง
                            while (currentChar < line.length) {
                                const char = line[currentChar];
                                
                                if (char === '"' && line[currentChar - 1] !== '\\') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    values.push(currentValue.replace(/^"|"$/g, '').trim());
                                    currentValue = '';
                                } else {
                                    currentValue += char;
                                }
                                
                                currentChar++;
                            }
                            
                            // เพิ่มค่าสุดท้าย
                            values.push(currentValue.replace(/^"|"$/g, '').trim());
                            
                            // สร้าง row object
                            rows.push({
                                c: values.map(value => ({ v: value }))
                            });
                        }
                    }

                    console.log('จำนวนแถวทั้งหมด:', rows.length); // แสดงจำนวนแถวเพื่อตรวจสอบ

                    originalData = rows;
                    filteredData2025 = filterDataByYear(rows, 2025);
                    console.log('จำนวนแถวปี 2025:', filteredData2025.length); // แสดงจำนวนแถวที่กรองแล้ว
                    updateChartAndTables(filteredData2025);
                    updateLineChart(filteredData2025);
                })
                .catch(error => {
                    console.error("เกิดข้อผิดพลาดในการดึงข้อมูล:", error);
                    const messageDiv = document.createElement('div');
                    messageDiv.style.padding = '10px';
                    messageDiv.style.margin = '10px 0';
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.style.borderRadius = '4px';
                    messageDiv.style.color = '#721c24';
                    messageDiv.innerHTML = 'เกิดข้อผิดพลาดในการดึงข้อมูล กรุณาลองใหม่อีกครั้ง';
                    document.querySelector('.controls').insertAdjacentElement('afterend', messageDiv);
                });
        }
        
        // ฟังก์ชันสำหรับกรองข้อมูลตามปี
        function filterDataByYear(data, year) {
            return data.filter(row => {
                const yearValue = row.c[41]?.v; // คอลัมน์ปี
                return yearValue === year.toString();
            });
        }

        // ฟังก์ชันเพื่ออัปเดตกราฟและตาราง
        function updateChartAndTables(rows, selectedMonth = null, selectedStatus = null) {
            const monthOrder = ['Jan25', 'Feb25', 'Mar25'];
            const statusList = ["ขึ้นทะเบียนเรียบร้อย", "ช่างลาออก", "ตัวแทนยังไม่ส่งขึ้นทะเบียน", "ติดประวัติอาชญากรรม", "อยู่ระหว่างอบรมปฎิบัติ", "เอกสารยังไม่ครบ"];
            const colors = ['#4dc9f6', '#f67019', '#f53794', '#537bc4', '#acc236', '#166a8f'];

            // Filter data based on selected month and status
            let filteredRows = rows;
            if (selectedMonth) {
                filteredRows = filteredRows.filter(row => row.c[28]?.v === selectedMonth);
            }
            if (selectedStatus) {
                filteredRows = filteredRows.filter(row => row.c[34]?.v === selectedStatus);
            }

            const chartData = {
                labels: monthOrder,
                datasets: statusList.map((status, index) => ({
                    label: status,
                    data: monthOrder.map(month => {
                        return filteredRows.filter(row => row.c[28]?.v === month && row.c[34]?.v === status).length;
                    }),
                    backgroundColor: status === "ขึ้นทะเบียนเรียบร้อย" ? '#006400' : colors[index]
                }))
            };

            const chartCanvas = document.getElementById('myChart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(chartCanvas, {
                type: 'bar',
                data: chartData,
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    plugins: {
                        datalabels: {
                            color: 'white',
                            anchor: 'center',
                            align: 'center',
                            formatter: Math.round,
                            font: {
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return 'รวม: ' + sum;
                                }
                            }
                        }
                    },
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grace: '15%',
                            ticks: {
                                stepSize: 10
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const datasetIndex = elements[0].datasetIndex;
                            const index = elements[0].index;
                            const clickedStatus = chart.data.datasets[datasetIndex].label;
                            const clickedMonth = chart.data.labels[index];
                            updateChartAndTables(filteredData2025, clickedMonth, clickedStatus);
                        } else {
                            updateChartAndTables(filteredData2025);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // แสดงผลรวมด้านบนกราฟ
            const ctx = chartCanvas;
            const datasets = chart.data.datasets;
            const labels = chart.data.labels;
            
            labels.forEach((label, index) => {
                let total = 0;
                datasets.forEach(dataset => {
                    total += dataset.data[index];
                });
                
                ctx.save();
                ctx.fillStyle = '#000';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                
                const meta = chart.getDatasetMeta(0);
                const x = meta.data[index].x;
                const y = chart.scales.y.getPixelForValue(chart.scales.y.max) - 20;
                
                ctx.fillText('รวม: ' + total, x, y);
                ctx.restore();
            });

            updateTables(filteredRows);
        }

        // ฟังก์ชันเพื่ออัปเดต Line Chart
        function updateLineChart(rows) {
            const monthOrder = ['Jan25', 'Feb25', 'Mar25'];
            const lineChartCanvas = document.getElementById('lineChart').getContext('2d');

            const lineChartData = {
                labels: monthOrder,
                datasets: [{
                    label: 'จำนวนการขึ้นทะเบียนช่างใหม่',
                    data: monthOrder.map(month => {
                        return rows.filter(row => row.c[28]?.v === month && row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย").length;
                    }),
                    backgroundColor: '#006400', // สีเขียวเข้ม
                    borderColor: '#006400',
                    fill: true
                }]
            };

            if (lineChart) {
                lineChart.destroy();
            }

            lineChart = new Chart(lineChartCanvas, {
                type: 'bar', // เปลี่ยนเป็นกราฟแท่ง
                data: lineChartData,
                options: {
                    responsive: true,
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: Math.round,
                            font: {
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // ฟังก์ชันเพื่ออัปเดตตาราง
        function updateTables(rows) {
            // อัปเดต Pivot Table
            updatePivotTable(rows);

            const dataBody = document.getElementById('data-body');
            dataBody.innerHTML = '';
            
            // Define column headers with their corresponding data keys
            const columnHeaders = [
                { text: "พื้นที่", key: "area" },
                { text: "รอบวันที่", key: "roundDate" },
                { text: "เดือนอบรม", key: "trainingMonth" },
                { text: "week", key: "week" },
                { text: "ชื่อ-นามสกุล", key: "name" },
                { text: "ชื่อ บจก./หจก/ร้าน (ตัวแทน)", key: "company" },
                { text: "รหัสตัวแทน", key: "agentCode" },
                { text: "จังหวัดที่ตั้งร้านตัวแทน", key: "province" },
                { text: "สถานะกองงาน (หัวหน้าหรือลูกน้อง)", key: "workStatus" },
                { text: "ผลการขึ้นทะเบียน", key: "registerResult" },
                { text: "Status ล่าสุด", key: "latestStatus" },
                { text: "วันเริ่มต้น", key: "startDate" },
                { text: "วันสิ้นสุด", key: "endDate" },
                { text: "SLA", key: "sla" },
                { text: "ปี", key: "year" }
            ];

            // Add column headers to the table
            const dataHeader = document.getElementById('data-table').getElementsByTagName('thead')[0];
            dataHeader.innerHTML = '';
            let headerRow = dataHeader.insertRow();
            columnHeaders.forEach(header => {
                let th = document.createElement("th");
                th.textContent = header.text;
                th.dataset.key = header.key;
                th.onclick = function() {
                    const isAsc = !this.classList.contains('sort-asc');
                    document.querySelectorAll('#data-table th').forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                    });
                    this.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
                    sortTable(header.key, isAsc);
                };
                headerRow.appendChild(th);
            });

            // Store the rows data globally for sorting
            window.tableData = rows.filter(row => row.c[41]?.v === '2025').map(row => {
                return {
                    area: row.c[26]?.v || '',
                    roundDate: row.c[1]?.v || '',
                    trainingMonth: row.c[2]?.v || '',
                    week: row.c[39]?.v || '',
                    name: row.c[3]?.v || '',
                    company: row.c[6]?.v || '',
                    agentCode: row.c[7]?.v || '',
                    province: row.c[8]?.v || '',
                    workStatus: row.c[13]?.v || '',
                    registerResult: row.c[33]?.v || '',
                    latestStatus: row.c[34]?.v || '',
                    startDate: row.c[35]?.v || '',
                    endDate: row.c[36]?.v || '',
                    sla: row.c[37]?.v || '',
                    year: row.c[41]?.v || ''
                };
            });

            // Initial render of the table data
            renderTableData(window.tableData);
        }

        // Function to render table data
        function renderTableData(data) {
            const dataBody = document.getElementById('data-body');
            dataBody.innerHTML = '';
            
            data.forEach(rowData => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${rowData.area || ''}</td>
                    <td>${rowData.roundDate || ''}</td>
                    <td>${rowData.trainingMonth || ''}</td>
                    <td>${rowData.week || ''}</td>
                    <td>${rowData.name || ''}</td>
                    <td>${rowData.company || ''}</td>
                    <td>${rowData.agentCode || ''}</td>
                    <td>${rowData.province || ''}</td>
                    <td>${rowData.workStatus || ''}</td>
                    <td>${rowData.registerResult || ''}</td>
                    <td>${rowData.latestStatus || ''}</td>
                    <td>${rowData.startDate || ''}</td>
                    <td>${rowData.endDate || ''}</td>
                    <td>${rowData.sla || ''}</td>
                    <td>${rowData.year || ''}</td>
                `;
                dataBody.appendChild(tr);
            });
        }

        // Function to sort table
        function sortTable(key, isAsc) {
            const sortedData = [...window.tableData].sort((a, b) => {
                let valueA = a[key];
                let valueB = b[key];

                // Handle numeric values
                if (!isNaN(valueA) && !isNaN(valueB)) {
                    valueA = Number(valueA);
                    valueB = Number(valueB);
                }

                // Handle empty values
                if (!valueA && valueA !== 0) return isAsc ? 1 : -1;
                if (!valueB && valueB !== 0) return isAsc ? -1 : 1;

                // Handle dates in format DD/MM/YYYY
                if (key === 'startDate' || key === 'endDate') {
                    if (valueA && valueB) {
                        const [dayA, monthA, yearA] = valueA.split('/').map(Number);
                        const [dayB, monthB, yearB] = valueB.split('/').map(Number);
                        const dateA = new Date(yearA, monthA - 1, dayA);
                        const dateB = new Date(yearB, monthB - 1, dayB);
                        return isAsc ? dateA - dateB : dateB - dateA;
                    }
                }

                // Handle week format (Week XX)
                if (key === 'week') {
                    const weekA = parseInt(valueA.replace('Week ', '')) || 0;
                    const weekB = parseInt(valueB.replace('Week ', '')) || 0;
                    return isAsc ? weekA - weekB : weekB - weekA;
                }

                // Handle month format (JanXX, FebXX, etc.)
                if (key === 'trainingMonth') {
                    const monthOrder = { 'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6, 
                                      'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12 };
                    const monthA = monthOrder[valueA.substring(0, 3)] || 0;
                    const monthB = monthOrder[valueB.substring(0, 3)] || 0;
                    return isAsc ? monthA - monthB : monthB - monthA;
                }

                // Default string comparison
                return isAsc ? 
                    valueA.toString().localeCompare(valueB.toString()) : 
                    valueB.toString().localeCompare(valueA.toString());
            });

            // Render sorted data
            renderTableData(sortedData);
        }

        function updatePivotTable(rows) {
            const pivotHeader = document.getElementById('pivot-header');
            const pivotBody = document.getElementById('pivot-body');
            pivotHeader.innerHTML = '';
            pivotBody.innerHTML = '';

            const thAreaMonth = document.createElement('th');
            thAreaMonth.textContent = 'จำนวนช่าง(คน)';
            pivotHeader.appendChild(thAreaMonth);

            // ดึงค่า Status ที่มีอยู่ทั้งหมดและเรียงลำดับ
            const statusValues = [...new Set(rows.map(row => row.c[34]?.v).filter(Boolean))].sort();

            // เพิ่ม column headers สำหรับแต่ละ Status
            statusValues.forEach(status => {
                const th = document.createElement('th');
                th.textContent = status;
                pivotHeader.appendChild(th);
            });

            const thGrandTotal = document.createElement('th');
            thGrandTotal.textContent = 'Grand Total';
            pivotHeader.appendChild(thGrandTotal);

            const monthOrder = ['Jan25', 'Feb25', 'Mar25'];
            let grandTotalByStatus = {};
            statusValues.forEach(status => grandTotalByStatus[status] = 0);

            // รวบรวมข้อมูลสำหรับแต่ละพื้นที่
            const areaData = new Map();
            rows.forEach(row => {
                const area = row.c[26]?.v;
                const month = row.c[28]?.v;
                const status = row.c[34]?.v;

                if (!area || !month || !status) return;

                if (!areaData.has(area)) {
                    areaData.set(area, {
                        monthData: {},
                        statusTotals: {},
                        total: 0
                    });
                    statusValues.forEach(s => areaData.get(area).statusTotals[s] = 0);
                    monthOrder.forEach(m => {
                        areaData.get(area).monthData[m] = {};
                        statusValues.forEach(s => areaData.get(area).monthData[m][s] = 0);
                    });
                }

                const areaInfo = areaData.get(area);
                if (monthOrder.includes(month)) {
                    areaInfo.monthData[month][status] = (areaInfo.monthData[month][status] || 0) + 1;
                    areaInfo.statusTotals[status] = (areaInfo.statusTotals[status] || 0) + 1;
                    areaInfo.total += 1;
                }
            });

            let overallGrandTotal = 0;

            // แสดงข้อมูลตามพื้นที่
            for (const [area, areaInfo] of areaData) {
                // สร้างแถวหัวพื้นที่
                const trArea = document.createElement('tr');
                const tdArea = document.createElement('td');
                tdArea.textContent = area;
                tdArea.style.fontWeight = 'bold';
                trArea.appendChild(tdArea);

                statusValues.forEach(() => {
                    const tdEmpty = document.createElement('td');
                    trArea.appendChild(tdEmpty);
                });
                trArea.appendChild(document.createElement('td'));
                pivotBody.appendChild(trArea);

                // แสดงข้อมูลรายเดือน
                monthOrder.forEach(month => {
                    const tr = document.createElement('tr');
                    const tdMonth = document.createElement('td');
                    tdMonth.textContent = month;
                    tr.appendChild(tdMonth);

                    let monthTotal = 0;
                    statusValues.forEach(status => {
                        const count = areaInfo.monthData[month][status] || 0;
                        const td = document.createElement('td');
                        td.textContent = count || '';
                        tr.appendChild(td);
                        monthTotal += count;
                        grandTotalByStatus[status] += count;
                    });

                    const tdMonthTotal = document.createElement('td');
                    tdMonthTotal.textContent = monthTotal || '';
                    tr.appendChild(tdMonthTotal);
                    pivotBody.appendChild(tr);
                    overallGrandTotal += monthTotal;
                });

                // แสดงผลรวมของพื้นที่
                const trAreaTotal = document.createElement('tr');
                const tdAreaTotal = document.createElement('td');
                tdAreaTotal.textContent = `${area} Total`;
                tdAreaTotal.style.fontWeight = 'bold';
                tdAreaTotal.className = 'area-total';
                trAreaTotal.appendChild(tdAreaTotal);

                statusValues.forEach(status => {
                    const td = document.createElement('td');
                    td.textContent = areaInfo.statusTotals[status] || '';
                    td.style.fontWeight = 'bold';
                    trAreaTotal.appendChild(td);
                });

                const tdTotal = document.createElement('td');
                tdTotal.textContent = areaInfo.total || '';
                tdTotal.style.fontWeight = 'bold';
                tdTotal.className = 'area-total';
                trAreaTotal.appendChild(tdTotal);
                pivotBody.appendChild(trAreaTotal);
            }

            // แสดงผลรวมทั้งหมด
            const trGrandTotal = document.createElement('tr');
            trGrandTotal.className = 'grand-total';
            const tdGrandTotal = document.createElement('td');
            tdGrandTotal.textContent = 'Grand Total';
            tdGrandTotal.style.fontWeight = 'bold';
            trGrandTotal.appendChild(tdGrandTotal);

            statusValues.forEach(status => {
                const td = document.createElement('td');
                td.textContent = grandTotalByStatus[status] || '';
                td.style.fontWeight = 'bold';
                trGrandTotal.appendChild(td);
            });

            const tdOverallTotal = document.createElement('td');
            tdOverallTotal.textContent = overallGrandTotal || '';
            tdOverallTotal.style.fontWeight = 'bold';
            trGrandTotal.appendChild(tdOverallTotal);
            pivotBody.appendChild(trGrandTotal);
        }

        // Restore original data on outside click
        document.addEventListener('click', event => {
            if (!event.target.closest('#chart-container')) {
                updateChartAndTables(filteredData2025);
            }
        });

        // ฟังก์ชันเพื่อดาวน์โหลดตารางเป็น Excel
        function downloadTableAsExcel() {
            const table = document.getElementById('data-table');
            const workbook = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(workbook, 'data-table.xlsx');
        }

        // ฟังก์ชันเพื่อดึงเฉพาะปีจากวันที่ในรูปแบบ Date(YYYY,MM,DD)
        function getYearFromGoogleSheetDate(dateString) {
            if (!dateString || !dateString.startsWith("Date(")) return null;
            const matches = dateString.match(/Date\((\d+),(\d+),(\d+)\)/);
            return matches ? parseInt(matches[1], 10) : null;
        }

        // ฟังก์ชันเพื่อแปลงวันที่ในรูปแบบ Date(YYYY,MM,DD) ให้เป็น DD/MM/YYYY
        function parseGoogleSheetDate(dateString) {
            if (!dateString || !dateString.startsWith("Date(")) return '';
            const matches = dateString.match(/Date\((\d+),(\d+),(\d+)\)/);
            if (!matches) return '';
            const year = parseInt(matches[1], 10);
            const month = parseInt(matches[2], 10) + 1;
            const day = parseInt(matches[3], 10);
            return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
        }

        // เพิ่ม event listener ให้ปุ่ม
        document.getElementById('refresh-button').addEventListener('click', fetchDataAndUpdateTable);
        document.getElementById('download-button').addEventListener('click', downloadTableAsExcel);

        // ดึงข้อมูลครั้งแรกเมื่อโหลดหน้าเว็บ
        fetchDataAndUpdateTable();

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        updateCurrentDateTime();
    </script>
</body>
</html>