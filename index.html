<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        .pivot-table th, .pivot-table td {
            background-color: #e6f3ff; /* สีพื้นหลังเหมือนในภาพ */
        }
        .pivot-table th:first-child, .pivot-table td:first-child {
            background-color: #d9ead3; /* สีเขียวอ่อนสำหรับคอลัมน์แรก */
        }
        .grand-total th, .grand-total td {
            background-color: #b7e1cd; /* สีเขียวเข้มสำหรับแถว Grand Total */
        }
        canvas {
            margin-top: 20px;
            max-width: 400px;
            max-height: 400px;
        }
        .controls {
            margin-bottom: 20px;
        }
        .controls button {
            margin-right: 10px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        .pivot-table {
            margin-bottom: 30px;
        }
        .header-container {
            background-color: #003366; /* สีน้ำเงินเข้ม */
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="header-container">
        <h1>ข้อมูลแดชบอร์ดจาก Google Sheets (เฉพาะปี 2025)</h1>
        <p id="current-date"></p>
    </div>
    <div class="controls">
        <button id="refresh-button">รีเฟรชข้อมูล</button>
        <button id="download-button">ดาวน์โหลด</button>
    </div>

    <!-- เพิ่มตาราง Pivot Table -->
    <h2>ตารางสรุป (Pivot Table)</h2>
    <table id="pivot-table" class="pivot-table">
        <thead>
            <tr id="pivot-header"></tr>
        </thead>
        <tbody id="pivot-body"></tbody>
    </table>

    <canvas id="myChart" width="400" height="400"></canvas>
    <table id="data-table">
        <thead>
            <tr></tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // แสดงวันที่ปัจจุบันในรูปแบบประเทศไทย
        const currentDateElement = document.getElementById('current-date');
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const thaiYear = now.getFullYear() + 543;
        const thaiDate = now.toLocaleDateString('th-TH', options).replace(now.getFullYear(), thaiYear);
        currentDateElement.textContent = `วันที่: ${thaiDate}`;

        // URL for Google Sheets JSON
        const sheetUrl = "https://docs.google.com/spreadsheets/d/1hsaIWrQmhwGJkR5IlCvCKoR2RTyC3jWhRoyEXqWZQs8/gviz/tq?tqx=out:json&sheet=แดชบอร์ดอบรมช่างใหม่";

        // ฟังก์ชันเพื่อดึงข้อมูลและอัปเดตตาราง
        function fetchDataAndUpdateTable() {
            fetch(sheetUrl)
                .then(response => response.text())
                .then(data => {
                    const jsonString = data.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/)[1];
                    const jsonData = JSON.parse(jsonString);
                    const rows = jsonData.table.rows;

                    // กำหนดดัชนีคอลัมน์
                    const columnIndices = {
                        AA: 26, AB: 27, AC: 28, AN: 39, // Filters: พื้นที่, รอบวันที่, เดือนอบรม, week
                        D: 3, G: 6, H: 7, I: 8, N: 13, AH: 33, AI: 34, AJ: 35, AK: 36, AL: 37, // คอลัมน์ในตารางหลัก
                        Status: 34 // เปลี่ยนจาก AH (Status อันดับ) เป็น AI (Status ล่าสุด)
                    };

                    const columnHeaders = {
                        AA: "พื้นที่", AB: "รอบวันที่", AC: "เดือนอบรม", AN: "week",
                        D: "D", G: "G", H: "H", I: "I", N: "N", AH: "Status อันดับ", AI: "Status ล่าสุด", AJ: "วันเริ่มต้น", AK: "วันสิ้นสุด", AL: "SLA"
                    };

                    // อัปเดตตารางหลัก
                    const thead = document.querySelector("#data-table thead tr");
                    const tbody = document.querySelector("#data-table tbody");
                    thead.innerHTML = '';
                    tbody.innerHTML = '';

                    // สร้างส่วนหัวตารางหลัก
                    Object.keys(columnIndices).forEach(key => {
                        if (key !== 'Status') { // ข้าม Status เพราะใช้ใน Pivot Table
                            const th = document.createElement("th");
                            th.textContent = rows[0].c[columnIndices[key]]?.v || columnHeaders[key];
                            thead.appendChild(th);
                        }
                    });

                    // เก็บข้อมูลสำหรับ Pivot Table
                    const pivotData = {};
                    const statusValues = new Set();
                    const areaMonthMap = {};

                    // กรองข้อมูลและเก็บข้อมูลสำหรับ Pivot Table
                    rows.slice(1).forEach(row => {
                        const yearAJ = getYearFromGoogleSheetDate(row.c[columnIndices.AJ]?.v);
                        if (yearAJ === 2025) {
                            // เพิ่มข้อมูลในตารางหลัก
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row.c[columnIndices.AA]?.v || ''}</td>
                                <td>${row.c[columnIndices.AB]?.v || ''}</td>
                                <td>${row.c[columnIndices.AC]?.v || ''}</td>
                                <td>${row.c[columnIndices.AN]?.v || ''}</td>
                                <td>${row.c[columnIndices.D]?.v || ''}</td>
                                <td>${row.c[columnIndices.G]?.v || ''}</td>
                                <td>${row.c[columnIndices.H]?.v || ''}</td>
                                <td>${row.c[columnIndices.I]?.v || ''}</td>
                                <td>${row.c[columnIndices.N]?.v || ''}</td>
                                <td>${row.c[columnIndices.AH]?.v || ''}</td>
                                <td>${row.c[columnIndices.AI]?.v || ''}</td>
                                <td>${parseGoogleSheetDate(row.c[columnIndices.AJ]?.v)}</td>
                                <td>${parseGoogleSheetDate(row.c[columnIndices.AK]?.v)}</td>
                                <td>${row.c[columnIndices.AL]?.v || ''}</td>
                            `;
                            tbody.appendChild(tr);

                            // เก็บข้อมูลสำหรับ Pivot Table
                            const area = row.c[columnIndices.AA]?.v || 'ไม่ระบุ';
                            const trainingMonth = row.c[columnIndices.AC]?.v || 'ไม่ระบุ'; // ใช้ AC (เดือนอบรม)
                            const status = row.c[columnIndices.Status]?.v || 'ไม่ระบุ'; // ใช้ Status ล่าสุด (AI)

                            // เพิ่ม Status ลงใน Set เพื่อใช้เป็นคอลัมน์
                            statusValues.add(status);

                            // เก็บข้อมูลสำหรับการจัดกลุ่ม
                            if (!areaMonthMap[area]) {
                                areaMonthMap[area] = new Set();
                            }
                            areaMonthMap[area].add(trainingMonth);

                            // สร้างคีย์สำหรับ Pivot Table (พื้นที่ + เดือนอบรม)
                            const pivotKey = `${area} - ${trainingMonth}`;
                            if (!pivotData[pivotKey]) {
                                pivotData[pivotKey] = {};
                            }
                            pivotData[pivotKey][status] = (pivotData[pivotKey][status] || 0) + 1;
                        }
                    });

                    // สร้างตาราง Pivot Table
                    const pivotHeader = document.getElementById('pivot-header');
                    const pivotBody = document.getElementById('pivot-body');
                    pivotHeader.innerHTML = '';
                    pivotBody.innerHTML = '';

                    // สร้างส่วนหัวของ Pivot Table
                    const thAreaMonth = document.createElement('th');
                    thAreaMonth.textContent = 'Row Labels';
                    pivotHeader.appendChild(thAreaMonth);

                    const statuses = Array.from(statusValues).sort();
                    statuses.forEach(status => {
                        const th = document.createElement('th');
                        th.textContent = status;
                        pivotHeader.appendChild(th);
                    });

                    const thGrandTotal = document.createElement('th');
                    thGrandTotal.textContent = 'Grand Total';
                    pivotHeader.appendChild(thGrandTotal);

                    // กำหนดลำดับเดือนอบรม
                    const monthOrder = ['Jan25', 'Feb25', 'Mar25'];

                    // สร้างแถวข้อมูลใน Pivot Table
                    let grandTotalByStatus = {};
                    statuses.forEach(status => grandTotalByStatus[status] = 0);
                    let overallGrandTotal = 0;

                    Object.keys(areaMonthMap).sort().forEach(area => {
                        // เพิ่มแถวสำหรับชื่อพื้นที่
                        const trArea = document.createElement('tr');
                        const tdArea = document.createElement('td');
                        tdArea.textContent = area;
                        tdArea.style.fontWeight = 'bold';
                        trArea.appendChild(tdArea);

                        // เพิ่มช่องว่างสำหรับคอลัมน์ Status และ Grand Total
                        statuses.forEach(() => {
                            const tdEmpty = document.createElement('td');
                            trArea.appendChild(tdEmpty);
                        });
                        const tdEmptyTotal = document.createElement('td');
                        trArea.appendChild(tdEmptyTotal);
                        pivotBody.appendChild(trArea);

                        // เพิ่มแถวสำหรับเดือนอบรม ตามลำดับที่กำหนด
                        let areaTotal = 0;
                        monthOrder.forEach(trainingMonth => {
                            if (areaMonthMap[area].has(trainingMonth)) {
                                const pivotKey = `${area} - ${trainingMonth}`;
                                const tr = document.createElement('tr');
                                const tdKey = document.createElement('td');
                                tdKey.textContent = trainingMonth;
                                tr.appendChild(tdKey);

                                let rowTotal = 0;
                                statuses.forEach(status => {
                                    const td = document.createElement('td');
                                    const count = pivotData[pivotKey]?.[status] || 0;
                                    td.textContent = count || '';
                                    rowTotal += count;
                                    grandTotalByStatus[status] += count;
                                    tr.appendChild(td);
                                });

                                const tdRowTotal = document.createElement('td');
                                tdRowTotal.textContent = rowTotal;
                                tr.appendChild(tdRowTotal);
                                pivotBody.appendChild(tr);

                                areaTotal += rowTotal;
                                overallGrandTotal += rowTotal;
                            }
                        });

                        // เพิ่มแถวผลรวมสำหรับแต่ละพื้นที่
                        const trAreaTotal = document.createElement('tr');
                        const tdAreaTotalLabel = document.createElement('td');
                        tdAreaTotalLabel.textContent = `${area} Total`;
                        tdAreaTotalLabel.style.fontWeight = 'bold';
                        trAreaTotal.appendChild(tdAreaTotalLabel);

                        statuses.forEach(status => {
                            const td = document.createElement('td');
                            td.textContent = ''; // ไม่แสดงผลรวมราย Status ในแถวนี้
                            trAreaTotal.appendChild(td);
                        });

                        const tdAreaTotal = document.createElement('td');
                        tdAreaTotal.textContent = areaTotal;
                        tdAreaTotal.style.fontWeight = 'bold';
                        trAreaTotal.appendChild(tdAreaTotal);
                        pivotBody.appendChild(trAreaTotal);
                    });

                    // เพิ่มแถว Grand Total
                    const trGrandTotal = document.createElement('tr');
                    trGrandTotal.className = 'grand-total';
                    const tdGrandTotalLabel = document.createElement('td');
                    tdGrandTotalLabel.textContent = 'Grand Total';
                    tdGrandTotalLabel.style.fontWeight = 'bold';
                    trGrandTotal.appendChild(tdGrandTotalLabel);

                    statuses.forEach(status => {
                        const td = document.createElement('td');
                        td.textContent = grandTotalByStatus[status];
                        td.style.fontWeight = 'bold';
                        trGrandTotal.appendChild(td);
                    });

                    const tdOverallGrandTotal = document.createElement('td');
                    tdOverallGrandTotal.textContent = overallGrandTotal;
                    tdOverallGrandTotal.style.fontWeight = 'bold';
                    trGrandTotal.appendChild(tdOverallGrandTotal);
                    pivotBody.appendChild(trGrandTotal);
                })
                .catch(error => console.error("เกิดข้อผิดพลาดในการดึงข้อมูล:", error));
        }

        // ฟังก์ชันเพื่อดาวน์โหลดตารางเป็น Excel
        function downloadTableAsExcel() {
            const table = document.getElementById('data-table');
            const workbook = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(workbook, 'data-table.xlsx');
        }

        // ฟังก์ชันเพื่อดึงเฉพาะปีจากวันที่ในรูปแบบ Date(YYYY,MM,DD)
        function getYearFromGoogleSheetDate(dateString) {
            if (!dateString || !dateString.startsWith("Date(")) return null;
            const matches = dateString.match(/Date\((\d+),(\d+),(\d+)\)/);
            return matches ? parseInt(matches[1], 10) : null;
        }

        // ฟังก์ชันเพื่อแปลงวันที่ในรูปแบบ Date(YYYY,MM,DD) ให้เป็น DD/MM/YYYY
        function parseGoogleSheetDate(dateString) {
            if (!dateString || !dateString.startsWith("Date(")) return '';
            const matches = dateString.match(/Date\((\d+),(\d+),(\d+)\)/);
            if (!matches) return '';
            const year = parseInt(matches[1], 10);
            const month = parseInt(matches[2], 10);
            const day = parseInt(matches[3], 10);
            return `${day.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}/${year}`;
        }

        // เพิ่ม event listener ให้ปุ่ม
        document.getElementById('refresh-button').addEventListener('click', fetchDataAndUpdateTable);
        document.getElementById('download-button').addEventListener('click', downloadTableAsExcel);

        // ดึงข้อมูลครั้งแรกเมื่อโหลดหน้าเว็บ
        fetchDataAndUpdateTable();
    </script>
</body>
</html>